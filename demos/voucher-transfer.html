<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
      #edgeTooltips {
        position: absolute;
        left: -300px;
        top: -100px;
      }
      #edgeTitle {
        position: relative;
        top: 0;
        left: 0;
        width: 150px;
        height: 70px;
        background: #fff;
        border: 1px solid #ccc;
      }
      #edgeDetail {
        position: relative;
        top: 0;
        left: 0;
        background: #d6efae;
        width: 200px;
      }
      .tooltips-common {
        font-size: 16px;
        margin: 0;
        padding-left: 10px;
      }
      .tooltips-money {
        padding-bottom: 5px;
      }
      .tooltips-date {
        font-size: 12px;
        color: #ccc;
      }
      .detail-content {
        margin-bottom: 10px;
      }
      .edge-code {
        margin: 0;
        padding-left: 10px;
        font-size: 12px;
      }
      .edge-value {
        padding-left: 10px;
      }
      #nodeTooltips {
        position: absolute;
        left: -300px;
        top: -100px;
        width: 150px;
        height: 200px;
        background: #abec90;
      }
    </style>
</head>
<body>
<div id="mountNode"></div>
<div id="edgeTooltips">
  <div id="edgeTitle">
    <p class='tooltips-common'>凭证开立</p>
    <p class='tooltips-common tooltips-money'>1000,000,000元</p>
    <p class='tooltips-common tooltips-date'>2019-09-10</p>
  </div>
  <div id="edgeDetail">
    <div class='detail-content'>
      <p class='edge-code'>交易编码：</p>
      <span class='edge-value'>1000190203455</span>
    </div>
    <div class='detail-content'>
      <p class='edge-code'>交易编码：</p>
      <span class='edge-value'>1000190203455</span>
    </div>
    <div class='detail-content'>
      <p class='edge-code'>交易编码：</p>
      <span class='edge-value'>1000190203455</span>
    </div>
  </div>
</div>
<div id='nodeTooltips'>
  节点提示信息
</div>
<script src="../build/g6.js"></script>
<script src="./assets/dagre.js"></script>
<script>
  const colorMap = {
    '凭证开立': '#72CC4A',
    '凭证转让': '#1A91FF',
    '凭证融资': '#FFAA15',
  }
  const data = {
    nodes: [
      {
        id: '1',
        label: '公司1'
      },
      {
        id: '2',
        label: '公司2'
      },
      {
        id: '3',
        label: '公司3'
      },
      {
        id: '4',
        label: '公司4'
      },
      {
        id: '5',
        label: '公司5'
      },
      {
        id: '6',
        label: '公司6'
      },
      {
        id: '7',
        label: '公司7'
      },
      {
        id: '8',
        label: '公司8'
      },
      {
        id: '9',
        label: '公司9'
      }
    ],
    edges: [
      {
        source: '1',
        target: '2',
        data: {
          type: '凭证开立',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '1',
        target: '3',
        data: {
          type: '凭证转让',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '2',
        target: '5',
        data: {
          type: '凭证开立',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '5',
        target: '6',
        data: {
          type: '凭证转让',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '3',
        target: '4',
        data: {
          type: '凭证融资',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '4',
        target: '7',
        data: {
          type: '凭证转让',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '1',
        target: '8',
        data: {
          type: '凭证转让',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      },
      {
        source: '1',
        target: '9',
        data: {
          type: '凭证融资',
          amount: '100,000,000,00 元',
          date: '2019-08-03'
        }
      }
    ]
  };

  G6.registerNode(
    'node',
    {
      drawShape: function drawShape(cfg, group) {
        const width = cfg.style.width;
        const stroke = cfg.style.stroke;
        const rect = group.addShape('rect', {
          attrs: {
            x: -width / 2,
            y: -15,
            width,
            height: 30,
            radius: 15,
            stroke,
            lineWidth: 0.6,
            fillOpacity: 1,
            fill: '#fff'
          }
        });
        const circleLeft = group.addShape('circle', {
          attrs: {
            x: -width / 2,
            y: 0,
            r: 3,
            fill: stroke
          }
        });
        const circleRight = group.addShape('circle', {
          attrs: {
            x: width / 2,
            y: 0,
            r: 3,
            fill: stroke
          }
        });
        return rect;
      },
      getAnchorPoints: function getAnchorPoints() {
        return [[0, 0.5], [1, 0.5]];
      },
      update: function (cfg, item) {
        const group = item.getContainer()
        const children = group.get('children')
        const node = children[0]
        const circleLeft = children[1]
        const circleRight = children[2]

        const {style: {stroke}, labelStyle} = cfg

        if (stroke) {
          node.attr('stroke', stroke)
          circleLeft.attr('fill', stroke)
          circleRight.attr('fill', stroke)
        }
      }
    },
    'single-shape'
  );

  G6.registerEdge('polyline', {
    itemType: 'edge',
    draw: function draw(cfg, group) {
      const startPoint = cfg.startPoint;
      const endPoint = cfg.endPoint;
      const centerPoint = {
        x: (startPoint.x + endPoint.x) / 2,
        y: (startPoint.y + endPoint.y) / 2
      };

      const Ydiff = endPoint.y - startPoint.y;

      const slope = Ydiff !== 0 ? 500 / Math.abs(Ydiff) : 0;

      const cpOffset = 16;
      const offset = Ydiff < 0 ? cpOffset : -cpOffset;

      const line1EndPoint = {
        x: startPoint.x + slope,
        y: endPoint.y + offset
      };
      const line2StartPoint = {
        x: line1EndPoint.x + cpOffset,
        y: endPoint.y
      };

      // 控制点坐标
      const controlPoint = {
        x:
        ((line1EndPoint.x - startPoint.x) * (endPoint.y - startPoint.y)) /
        (line1EndPoint.y - startPoint.y) +
        startPoint.x,
        y: endPoint.y
      };

      let path = [
        ['M', startPoint.x, startPoint.y],
        ['L', line1EndPoint.x, line1EndPoint.y],
        [
          'Q',
          controlPoint.x,
          controlPoint.y,
          line2StartPoint.x,
          line2StartPoint.y
        ],
        ['L', endPoint.x, endPoint.y]
      ];

      if (Ydiff === 0) {
        path = [
          ['M', startPoint.x, startPoint.y],
          ['L', endPoint.x, endPoint.y]
        ];
      }

      const line = group.addShape('path', {
        attrs: {
          path,
          stroke: colorMap[cfg.data.type],
          lineWidth: 1.2,
          endArrow: false
        }
      });

      const labelLeftOffset = 8;
      const labelTopOffset = 8;
      // amount
      const amount = group.addShape('text', {
        attrs: {
          text: cfg.data.amount,
          x: line2StartPoint.x + labelLeftOffset,
          y: endPoint.y - labelTopOffset - 2,
          fontSize: 14,
          textAlign: 'left',
          textBaseline: 'middle',
          fill: '#000000D9'
        }
      });
      // type
      const type = group.addShape('text', {
        attrs: {
          text: cfg.data.type,
          x: line2StartPoint.x + labelLeftOffset,
          y: endPoint.y - labelTopOffset - amount.getBBox().height - 2,
          fontSize: 10,
          textAlign: 'left',
          textBaseline: 'middle',
          fill: '#000000D9'
        }
      });
      // date
      const date = group.addShape('text', {
        attrs: {
          text: cfg.data.date,
          x: line2StartPoint.x + labelLeftOffset,
          y: endPoint.y + labelTopOffset + 4,
          fontSize: 12,
          fontWeight: 300,
          textAlign: 'left',
          textBaseline: 'middle',
          fill: '#000000D9'
        }
      });
      return line;
    }
  });

  const g = new dagre.graphlib.Graph();
  g.setDefaultEdgeLabel(function() {
    return {};
  });
  g.setGraph({
    rankdir: 'LR'
  });

  data.nodes.forEach(function(node) {
    g.setNode(node.id + '', {
      width: 280,
      height: 100
    });
  });

  data.edges.forEach(function(edge) {
    edge.source = edge.source + '';
    edge.target = edge.target + '';
    g.setEdge(edge.source, edge.target);
  });
  dagre.layout(g);

  let coord = void 0;
  g.nodes().forEach(function(node, i) {
    coord = g.node(node);
    data.nodes[i].x = coord.x;
    data.nodes[i].y = coord.y;
  });
  g.edges().forEach(function(edge, i) {
    coord = g.edge(edge);
    const startPoint = coord.points[0];
    const endPoint = coord.points[coord.points.length - 1];
    data.edges[i].startPoint = startPoint;
    data.edges[i].endPoint = endPoint;
    data.edges[i].controlPoints = coord.points.slice(
      1,
      coord.points.length - 1
    );
  });

  const graph = new G6.Graph({
    container: 'mountNode',
    width: 1000,
    height: 800,
    modes: {
      default: ['drag-canvas']
    },
    defaultNode: {
      shape: 'node',
      labelCfg: {
        style: {
          fill: '#000000A6',
          fontSize: 10
        }
      },
      style: {
        stroke: '#72CC4A',
        width: 150
      }
    },
    defaultEdge: {
      shape: 'polyline'
    }
  });

  graph.data(data);
  graph.render();

  const edges = graph.getEdges()
  edges.forEach(edge => {
    const line = edge.getKeyShape()
    const stroke = line.attr('stroke')
    const targetNode = edge.getTarget()
    targetNode.update({
      style: {stroke}
    })
  })
  graph.paint()

  const edgeTooltips = document.getElementById('edgeTooltips')
  graph.on('edge:mouseenter', evt => {
    const { item, target } = evt
    const type = target.get('type')
    if(type !== 'text') {
      return
    }
    const model = item.getModel()
    const { endPoint } = model
    // y=endPoint.y - height / 2，在同一水平线上，x值=endPoint.x - width - 10
    const y = endPoint.y - 35
    const x = endPoint.x - 150 - 10
    const point = graph.getCanvasByPoint(x, y)
    edgeTooltips.style.top = point.y + 'px'
    edgeTooltips.style.left = point.x + 'px'
  })

  graph.on('edge:mouseleave', evt => {
    edgeTooltips.style.top = '-100px'
    edgeTooltips.style.left = '-300px'
  })

  const nodeTooltips = document.getElementById('nodeTooltips')
  graph.on('node:mouseenter', evt => {
    const { item, target } = evt
    const model = item.getModel()
    const { x, y } = model
    const point = graph.getCanvasByPoint(x, y)
    nodeTooltips.style.top = point.y + 25 + 'px'
    nodeTooltips.style.left = point.x - 70 + 'px'
  })

  graph.on('node:mouseleave', evt => {
    nodeTooltips.style.top = '-100px'
    nodeTooltips.style.left = '-300px'
  })
</script>