<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="mountNode"></div>
<script src="../build/g6.js"></script>
<script src="./assets/d3-4.13.0.min.js"></script>
<script src="./assets/sankey.js"></script>
<script src="./assets/jquery-3.2.1.min.js"></script>
<script>
  const margin = {top: 1, right: 1, bottom: 6, left: 1};
  const width = 960 - margin.left - margin.right;
  const height = 500 - margin.top - margin.bottom;
  const colors = ['#FD8C3D', '#D83F43', '#F7BED6', '#E487C7', '#46A848', '#D83F43', '#3B85BA', '#48335B', '#B7CDE9'];

  G6.registerEdge('sankey', {
    draw(cfg, group) {
      const data = cfg.data;
      const shape = group.addShape('path', {
        attrs: {
          stroke: 'rgba(0, 0, 0, 0.2)',
          lineWidth: Math.max(1, data.dy),
          path: path(data)
        }
      });
      return shape;
    }
  }, 'line');
  var svg = d3.select("#mountNode").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var sankey = d3.sankey()
    .nodeWidth(15)
    .nodePadding(10)
    .size([width, height]);

  var path = sankey.link();

  d3.json("./assets/energy.json", function(energy) {
    sankey
      .nodes(energy.nodes)
      .links(energy.links)
      .layout(32);
    console.log(energy)
    const nodes = [];
    const edges = [];
    energy.nodes.forEach(node => {
      nodes.push({
        id: node.name,
        label: node.name,
        style: { fill: colors[Math.round( Math.random() * 9)] },
        x: node.x + 7.5,
        y: node.y + node.dy / 2 ,
        size: [ 15, node.dy ],
        shape: 'rect',
        labelCfg: { labelPosition: node.x > 480 ? 'right': 'left' }
      });
    });
    energy.links.forEach(edge => {
      const source = edge.source;
      const target = edge.target;
      edges.push({
        id: source.name + ':' + target.name,
        source: source.name,
        target: target.name,
        shape: 'sankey',
        data: edge
      });
    });
    var link = svg.append("g").selectAll(".link")
      .data(energy.links)
      .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .style('stroke', '#ebebeb')
      .style('fill', '#ebebeb')
      .sort(function(a, b) { return b.dy - a.dy; });

    link.append("title")
      .text(function(d) { return d.source.name + " â†’ " + d.target.name });

    var node = svg.append("g").selectAll(".node")
      .data(energy.nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })


    node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { return d.color = '#ccc'; })
      .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
      .append("title")
      .text(function(d) { return d.name + "\n"; });

    node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
      .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

    function dragmove(d) {
      d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
      sankey.relayout();
      link.attr("d", path);
    }
  });

</script>
</body>
</html>
